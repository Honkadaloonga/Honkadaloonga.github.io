<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <link rel="stylesheet" href="style.css">
    </head>

    <body>
        <canvas id="canvas" width="600" height="600"></canvas>
        <input id="rotation" class="inputs " type="range" min="0" max="6.283185" step="0.0001" value="0" size="600">
        <div id="inputsWrap">
            <table style="width: 100%; height: 100%; padding: 0 8px 0 2px;">
                <tr><td>x1</td><td><input id="x1" class="inputs" type="range" min="-1.570796" max="1.570796" step="0.01" value="0"></td></tr>
                <tr><td>y1</td><td><input id="y1" class="inputs" type="range" min="-3.141592" max="3.141592" step="0.01" value="0"></td></tr>
                <tr><td>z1</td><td><input id="z1" class="inputs" type="range" min="-3.141592" max="3.141592" step="0.01" value="0"></td></tr>
                <tr><td>x2</td><td><input id="x2" class="inputs" type="range" min="-1.570796" max="1.570796" step="0.01" value="0"></td></tr>
                <tr><td>y2</td><td><input id="y2" class="inputs" type="range" min="-3.141592" max="3.141592" step="0.01" value="0"></td></tr>
                <tr><td>z2</td><td><input id="z2" class="inputs" type="range" min="-3.141592" max="3.141592" step="0.01" value="0"></td></tr>
                <tr><td>ct</td><td><input id="ct" class="inputs" type="range" min="-3.141592" max="3.141592" step="0.01" value="0"></td></tr>
                <tr><td>cp</td><td><input id="cp" class="inputs" type="range" min="-1.570796" max="1.570796" step="0.01" value="0"></td></tr>
                <tr><td>sc</td><td><input id="sc" class="inputs" type="range" min="1" max="5" step="0.01" value="2"></td></tr>
                <tr><td colspan="2"><button>Randomize</button></td></tr>
            </table>
        </div>
    </body>

    <script src="./shader.vert.js"></script>
    <script src="./shader.frag.js"></script>

    <script> /* ---- Canvas init ---- */
        const canvas = document.getElementById("canvas");
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    </script>

    <script> /* ---- WebGL init ---- */
        const gl = canvas.getContext("webgl2");
        const program = gl.createProgram();
        let vars = {
            rotation: 0,
            rot1: [0, 0, 0],
            rot2: [0, 0, 0],
            center: [0, 0],
            scale: 0,
            ar: canvas.width / canvas.height
        };

        function WebGLInit() {
            let vertShader = loadShader(gl, gl.VERTEX_SHADER, vertSrc);
            let fragShader = loadShader(gl, gl.FRAGMENT_SHADER, fragSrc);

            gl.attachShader(program, vertShader);
            gl.attachShader(program, fragShader);
            gl.linkProgram(program);

            if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
                const programLog = gl.getProgramInfoLog(program);
                console.error("\n"+programLog);
                alert('Unable to initialize the shader program:\n' + programLog);
                return null;
            }

            let positionLocation = gl.getAttribLocation(program, "a_pos");
            let buffer = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
            gl.bufferData(
                gl.ARRAY_BUFFER,
                new Float32Array([
                    -1.0, -1.0,
                    1.0, -1.0,
                    -1.0, 1.0,
                    -1.0, 1.0,
                    1.0, -1.0,
                    1.0,  1.0]),
                gl.STATIC_DRAW
            );

            gl.vertexAttribPointer(positionLocation, 2, gl.FLOAT, false, 0, 0);
            gl.enableVertexAttribArray(positionLocation);
            gl.useProgram(program);

            gl.uniform1f(gl.getUniformLocation(program, "rotation"), vars.rotation);
            gl.uniform1f(gl.getUniformLocation(program, "ar"), vars.ar);

            gl.drawArrays(gl.TRIANGLES, 0, 6);
        }

        function loadShader(gl, type, source) {
            const shader = gl.createShader(type);
            gl.shaderSource(shader, source);
            gl.compileShader(shader);
            if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
                const shaderLog = gl.getShaderInfoLog(shader);
                console.error("\n"+shaderLog);
                alert('An error occurred compiling the shaders:\n'+shaderLog);
                gl.deleteShader(shader);
                return null;
            }
            return shader;
        }
    </script>

    <script> /* ---- Event listener init ---- */
        WebGLInit();

        function sliderVal(id) {
            return Number(document.getElementById(id).value);
        }

        let prevVars = JSON.parse(JSON.stringify(vars));
        setInterval(function() {
            vars.rotation = sliderVal("rotation");
            vars.rot1 = [sliderVal("x1"), sliderVal("y1"), sliderVal("z1")];
            vars.rot2 = [sliderVal("x2"), sliderVal("y2"), sliderVal("z2")];
            vars.center = [sliderVal("ct"), sliderVal("cp")];
            vars.scale = sliderVal("sc");
            if (JSON.stringify(prevVars) != JSON.stringify(vars)) {
                prevVars = JSON.parse(JSON.stringify(vars));
                gl.uniform1f(gl.getUniformLocation(program, "rotation"), vars.rotation);
                gl.uniform3fv(gl.getUniformLocation(program, "rot1"), vars.rot1);
                gl.uniform3fv(gl.getUniformLocation(program, "rot2"), vars.rot2);
                let ct = vars.center[0];
                let cp = vars.center[1];
                let center = [Math.cos(ct)*Math.sin(cp), Math.sin(ct)*Math.sin(cp), Math.cos(cp)];
                gl.uniform3fv(gl.getUniformLocation(program, "center"), center);
                gl.uniform1f(gl.getUniformLocation(program, "scale"), vars.scale);
                gl.drawArrays(gl.TRIANGLES, 0, 6);
            }
        }, 33);

        let inputs = document.getElementsByClassName("inputs");
        for (let i = 0; i < inputs.length; i++) {
            let k = inputs[i];
            let m = k.id == "rotation" ? 0.0002 : 0.0005;
            k.addEventListener("mousewheel", function(event) {
                    let nval = k.value - (event.deltaY * (k.max - k.min) * m);
                    nval = nval < k.min ? k.max - nval : nval > k.max ? nval - k.max : nval;
                    k.value = nval;
            });
        }

        

    </script>
</html>
